<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout">
<head>
<title> Plan Your Trip! </title>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
<link rel="stylesheet" th:href="@{/styles/plan.css}">
<style type="text/css" >
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d2b656d20ccafdc06e8cff4e6a7e35ef"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" th:inline="javascript" th:src="@{/js/plan.js}"></script>
<script th:inline="javascript" type="text/javascript">
	var flowNum = 1;
	var flowNameId = "";
	var placeLat=0;
	var placeLng=0;
	var positions = [];
	

	$(function(){
		var user_num = $("#userNum").val(); // 실제 구현시 세션에 저장된 user_num 가져오기
		var plan_num = $("#plannum").val(); //플랜넘버 타임리프로 가져온값 가져옴
		console.log("plan_num: "+plan_num);
		var flowNumCnt =0;
		var flowNameCnt =0;
		var placeNumCnt =0;
		var delBtnCnt =0;
		var group_num;
		
		//map 생성 
		var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
			mapOption = { 
			    center: new kakao.maps.LatLng(37.556317, 126.922713), // 지도의 중심좌표
			    level: 3 // 지도의 확대 레벨
			};
	
		//지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
		var map = new kakao.maps.Map(mapContainer, mapOption);
			
		// 마커 이미지의 이미지 주소.
		var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 	
			
		//장소의 위도 경도 가져오는 함수.
		function placeLatLng(placeNum){
			$.ajax({
				url:"/getPlace",
				data:{place_num:placeNum},
				success:function(data){
					//가져온값 변수에 저장;
					placeName = data.place_name;
					lat = data.place_lat;
					lng = data.place_lng;
					
					//카카오맵 연결을 위해 latlng 변수생성후, 새로운 LatLng 객체 생성.
					latlng = new kakao.maps.LatLng(lat, lng);
					
					//여러 값 저장을 위해 positions array에 저장.
					positions.push({title:placeName, placenum:placeNum, latlng : latlng})
					
					//해당위치로 지도 이동 및 마커 표출 
					map.panTo(latlng);
					showMarker(latlng);
					
					console.log(latlng);
				}		 		
			})
		};
		
		//카카오 맵 마커 생성 function
	 	function showMarker(){
			
			for (var i = 0; i < positions.length; i++) {
			 	
			    // 마커 이미지의 이미지 크기 입니다
			    var imageSize = new kakao.maps.Size(24, 35); 
			    
			    // 마커 이미지를 생성합니다    
			    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
			    
			    // 마커를 생성합니다
			    var marker = new kakao.maps.Marker({
			        map: map, // 마커를 표시할 지도
			        position: positions[i].latlng, // 마커를 표시할 위치
			        title : positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
			        image : markerImage // 마커 이미지 
			    });
			}
		}
		
		// plan_group_num & title
 		$("#btnGrpAdd").on("click", function(){
			$("#planList").hide();
			$("#planText").show();
			$(this).hide();
			$("#btnGrpList").show();
			$.ajax({
				url:"/getNextGroupNum",
				success:function(data){
					$(".planGrpNum").attr('value',data);
				}
			})
		});
		
 		$("#btnGrpList").on("click", function(){
 			$("#planList").show();
 			$("#planText").hide();
 			$(this).hide();
 			$("#btnGrpAdd").show();
 		});
 		
 		$("#planList").on("change", function(){
  			var text = $("#planList option:selected").text();
  			$("#planText").attr({value:text});
 		});
 		
 		$("#placeList > li").on("click", function(){
 			placeName = $(this).text();
 			placeNum = $(this).val();
 			$("#"+flowNameId).attr({value:placeName});
 			$("#"+flowNameId).next().val(placeNum);
 			placeLatLng(placeNum);
 		});
 		
 		$("#AddPlan").on("click", function(){
 			
 			var inputFlowNum = $("<div name='plan_flow_num'></div>").attr({
 				id:"flowNum"+flowNumCnt++,
 				class: "form-control flowNum",
 				style: "text-align:center"
 			}).html(flowNum++)
 			
 			var inputFlowName = $("<input name='plan_flow_name' onclick='selectFlowName(this)'>").attr({
 				id: "flowText"+flowNameCnt++,
 				type: "text",
 				name: "plan_name",
 				class :"form-control flowText",
 				style: "width: 70%"
			});
 			
 			var input_num = $("<input name='place.place_num'>").attr({
 				type: "hidden",
 				//현재 선택된 장소의 경도 위도 가져오는 함수 실행.
			});
 
 			var delBtn = $("<button onclick='del(this)'>x</button>").attr({
 				id:"btnDel"+delBtnCnt++,
 				type:"button",
 				class:"btn btn-dark btnDel"
 			});
 			
 			var str = $("<div></div>").attr({
 				name: "plan_name",
 				class: "input-group div mb-1"
 			}).append(inputFlowNum,inputFlowName,input_num,delBtn);

 			
 			$("#inputAppend").append(str);
 			
 		})
 		
 		//동선입력에 변경이 생기면 새로 번호 부여 및 지도 새로 표시
 		$("#inputAppend").on("change", function(){
			
		})
	
	})
 	
	function del(id){
		 $(id).parent("div").remove();
		 flowNum--;
	}
	
	function selectFlowName(name){
		flowNameId = name.id;
		console.log(name.id);
	}

</script>
</head>
<body>

<h3>PLAN</h3>
<hr>

<div class="container border">
    <form action="/savePlan" method="post">
     <div class="form-inline">
		<!-- 여행 타이틀 (plan_group_num) -->
		<div class="input-group grpNum">
			<input style="display: none" id="planText" type="text" class="form-control planGroupTxt" name="plan_name">
			<select id="planList" name="plan_group_num" class="form-select planGroupOpGrp" aria-label="select-plan-group">
				<option selected disabled>여행 계획 선택</option>
				<option th:each="pl:${plan_list}" th:value="${pl.plan_group_num}" th:text="${pl.plan_name}" class="planGroupOp"></option>
			</select>
			
			
		<!-- 플랜 그룹 넘버(plan_group_num) : <input type="number" name="plan_group_num" th:value="${groupnum}"><br>
			플랜 그룹 이름(plan_name) : <input type="text" name="plan_name" th:value="${plan_name}"><br> -->
			<div class="input-group-addon input-group-button">
				<button type="button" id="btnGrpAdd" class="btn btn-dark">새그룹추가</button>
				<button style="display: none" type="button" id="btnGrpList" class="btn btn-dark">리스트보이기</button>
				<button type="button" id="btnGrpDel" class="btn btn-dark">삭제</button>
			</div>
		</div>
	</div> 
	<!-- 여기까지 여행 타이틀 -->
	
	<!-- 여기부터 주요 컨텐츠 -->
	<div class="row bottom border">
	   		<div id="map" class="col border rounded"></div> <!-- 지도 map --> <!-- 왼쪽 -->
	   	<div class="col right border rounded"> <!-- 오른쪽 -->
	   	
	     	<!-- 여행 날짜(plan_date) -->
   			<div class="row justify-content-center date input-group-addon input-group-button">
	     		<input type="date" name="plan_date" th:value="${plan_date}" class="col-5">
	     		<button type="button" id="AddPlan" class="btn btn-dark col-2">동선추가</button>
   				<div class="btnPlaceListAll btn-group">
	     			<div class="btn_place_list">
					<button id="btnPlace" class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">장소 선택</button>
						<ul id="placeList" class="dropdown-menu">
							<li  id="placeListOp" class="dropdown-item" th:each="p:${place_list}" th:value="${p.place_num}" th:text="${p.place_name}">
								<span></span>
							</li>
						</ul>
					</div>
					<div class="btn_dibs_list">
					<button id="btnDibs" class="btn btn-secondary btn-sm dropdown-toggle display:flex" type="button" data-bs-toggle="dropdown" aria-expanded="false">찜 리스트</button>
						<ul id="dibsList" class="dropdown-menu btnDibs">
							<li id="dibsListOp" class="dropdown-item" th:each="d:${dibs}" th:text="${d.place.place_name}" th:value="${d.place.place_num}"></li>
						</ul>
					</div>
					<div class="btn_rsv_list">
					<button id="btnRsv" class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">예약 리스트</button>
						<ul id="rsvList" class="dropdown-menu">
							<li id="rsvListOp" class="dropdown-item" th:each="r:${reservation}" th:text="${r.place.place_name}" th:value="${r.place.place_num}" ></li>
						</ul>
					</div>
   				</div><!--장소, 찜, 예약 리스트 버튼그룹 div End -->
     		</div>
		<!-- 플랜 그룹 정보 -->
		<div class="border input_box">
			<!-- 유저 번호(user_num) -->
			<input type="hidden" id="userNum" name="userinfo.user_num" th:value="${user.user_num}">
			<!-- 여행 세부 내용 -->
			<input id="plannum" type="hidden" name="plan_num" th:value="${plannum}">			

			<div class="input-group" >
				<div id="inputAppend"></div>
			</div><!-- input-group 끝 -->
		</div><!-- input_box 끝 -->
		
	   <!-- 입력, 수정, 삭제 버튼위치 -->
	 	<div class="d-flex justify-content-end btnAll"  aria-label="save, delete button">
		  <button id="btnSubmit" type="submit" class="btn btn-dark">수정/저장</button>
		  <button type="reset" class="btn btn-dark"> 리셋</button>
		  <button id="btnDelete" type="button" class="btn btn-dark">삭제</button>
		</div>		
 	 </div><!-- 오른쪽 박스 끝 -->
  	 </div><!-- bottom 박스 끝 -->
	</form>
</div> <!-- 전체 컨테이너 끝-->
</body>
</html>
